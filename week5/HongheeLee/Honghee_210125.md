# JPA 프로그래밍 - 기본편 4일차(연관관계 매핑 기초)

## 연관관계 매핑 기초

목표 : 객체와 테이블 연관관계의 차이를 이해 + 객체의 참조와 테이블의 외래키를 매핑

필요한 이유 : 객체를 테이블에 맞추어 데이터 중심으로 모델링하면 객체들의 협력 관계 만들 수 없다.

### 단방향 연관관계

객체의 참조와 테이블의 외래키를 매핑할 때 객체 지향 모델링을 할 수 있다.

객체의 필드에 외래키값을 넣는 것이 아니라 참조 객체 자체를 넣고 어노테이션으로 연관관계를 표시해준다. 

@ManyToOne : 현재 객체가 N, 필드에 들어온 객체가 1일 때

@JoinColumn(name = ) :외래키가 무엇인지, 어떤 키를 기준으로 컬럼을 join하는지.

연관관계 저장, 조회, 수정할 때도 외래키를 거치지 않고 참조를 사용해서 바로 할 수 있다.

### 양방향 연관관계와 연관관계의 주인

반대 방향으로 객체 그래프 탐색할 수 있음. 하지만 객체는 양방향보다는 단방향이 좋다.

테이블의 연관관계에는 방향이라는 개념이 없음. FK만 넣으면 양쪽으로 연관관계 다 알 수 있음. 하지만 객체에서는 양쪽에 객체를 모두 넣어줘야 양쪽으로 갈 수 있음. 

양방향일 때 객체와 테이블이 관계를 맺는 차이

- 객체 연관관계 =  서로 다른 단방향 연관관계 2개

- 테이블 연관관계 = 양방향 연관관계 1개(외래키 하나로 양쪽으로 다 조인 가능)

서로 다른 단방향 연관관계 2개일 때 둘 중 하나로 외래키를 관리해야 한다 -> 연관관계 주인

**연관관계 주인**

- 객체의 두 관계 중 하나를 연관관계 주인으로 지정

- 연관관계 주인만이 외래 키를 관리(등록, 수정)

- 주인이 아닌 쪽은 읽기만 가능

- 주인은 mappedBy 속성 사용 X, 주인이 아니면 mappedBy 속성으로 주인 지정

**외래키가 있는 쪽을 연관관계 주인으로 정해라!!!!**(비즈니스 로직으로 결정 X)

(DB입장에서는 외래키가 있는 쪽이 N, 없는 쪽이 1이니까 N쪽이 연관관계 주인이 된다.)

양방향 매핑시 실수 -> 연관관계의 주인에 값을 입력하지 않음

- but 순수한 객체 관계 고려하면 항상 양쪽에 값을 설정해야 한다. (연관관계 편의 메소드 사용)

  ```java
  public void changeTeam(Team team) {
          this.team = team;
          team.getMembers().add(this);}
  ```

- 양방향 매핑시에 무한 루프를 조심하자 : toString(), lombok 등

- 컨트롤러에서 엔티티를 반환하지 말고 DTO(순수한 데이터 객체)로 반환하자. 아니면 API가 엔티티를 의존성이 생기고 엔티티가 복잡해진다.

**정리**

- 단방향 매핑만으로도 이미 연관관계 매핑은 완료

- 양방향 매핑은 반대 방향으로 조회 기능이 추가된 것 뿐, 단방향 매핑 잘해두고 양방향은 필요할 때 추가하면 됨(테이블에 영향 X)

프로젝트 시작 전에 UML과 ERD를 그린 후 개발한다. 무료툴인 draw.io 이용.
