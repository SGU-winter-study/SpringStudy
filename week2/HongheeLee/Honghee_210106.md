## 의존관계 자동 주입

### 롬복과 최신 트랜드

생성자 주입 다 좋은데 코드가 좀 길다. 필드 주입처럼 편리하게 사용하고 싶어서 롬복 라이브러리 활용. 롬복 라이브러리가 제공하는 @RequiredArgsConstructor 기능을 사용하면 final이 붙은 필드를 모아서 생성자를 자동으로 만들어준다. 

최근에는 생성자 딱 1개만 두고 @Autowired 생략하는 방법 주로 사용하는데 여기에 Lombok 라이브러리까지 같이 사용하면 코드 깔끔하게 쓸 수 있다.

### 조회 빈이 2개 이상인 문제와 해결

#### 문제

@Autowired는 타입으로 조회하기 때문에 타입이 같으면 여러 빈이 선택될 수 있고  그렇게 2개 이상 선택된 상태로 의존관계 자동주입을 실행하면 NoUniqueBeanDefinitionException 오류가 발생한다.

#### 해결

1. **@Autowired 필드명 매칭**

   @Autowired는 먼저 타입 매칭을 시도하고 여러 빈이 있으면 필드 이름이나 파라미터 이름으로 빈 이름을 추가 매칭한다. 타입이 일치하는 빈이 하나만 있으면 이름과 상관없이 매칭된다.

2. **@Qualifier 사용**

   추가 구분자를 붙여주는 방법이다. 추가적인 방법을 제공하는 거지 빈 이름 자체를 변경하는 것은 아님.  빈 등록시 @Qualifier를 붙여주고 주입시에 @Qualifier를 붙여주고 등록한 이름을 적어준다. @Qualifier끼리 매칭되지 않으면 빈 이름에서도 추가로 찾고 거기서도 없으면 예외 발생한다. 

3. **@Primary** 사용

   우선순위를 정하는 방법이다.  @Autowired에 여러 빈이 매칭될 때 @Primary가 붙은 빈이 우선권을 가진다.  

실제로는 자주 쓰는 사용하는 메인 DB 커넥션을 획득하는 스프링 빈에 @Primary를 적용하고 가끔 사용하는 서브DB 커넥션을 획득하는 스프링 빈에는 @Qualifier를 지정해주는 것처럼 같이 사용할 수 있다. 우선순위는 늘 자동보다 수동이기 때문에 @Qualifier가 더 우선순위는 높다.

#### 애노테이션 직접 만들기

@Qualifier("~~") 이렇게 문자를 적으면 컴파일시 타입 체크가 안된다. 직접 애노테이션 만들어서 애노테이션을 붙이고 그걸 체크하도록 하자.

### 조회한 빈이 모두 필요할 때, List, Map

해당 타입의 스프링 빈이 다 필요한 경우도 있다. 예를 들어서 할인 서비스를 제공하는데, 클라이언트가 할인의 종류(rate, fix)를 선택할 수 있다고 가정해보자. 스프링을 사용하면 소위 말하는 전략 패턴을 매우 간단하게 구현할 수 있다.

### 자동, 수동의 올바른 실무 운영 기준

**편리한 자동 기능을 기본으로 사용하자**

전반적으로 자동을 선호하는 추세이고 자동 빈 등록으로도 OCP, DIP 지킬 수 있다. 또한 수동으로 하면 설정 정보에 가서 하나하나 @Bean 적고 객체 생성하는 일이 번거롭고 관리할 빈 많으면 설정 정보 커져 설정 정보 관리하는 것도 부담된다.

**특별히 수동 빈 등록 사용하는 경우**

업무 로직 빈: 웹을 지원하는 컨트롤러, 핵심 비즈니스 로직이 있는 서비스, 데이터 계층의 로직을 처리하는 리포지토리등이 모두 업무 로직이다. 보통 비즈니스 요구사항을 개발할 때 추가되거나 변경된다.

기술 지원 빈: 기술적인 문제나 공통 관심사(AOP)를 처리할 때 주로 사용된다. 데이터베이스 연결이나, 공통 로그 처리 처럼 업무 로직을 지원하기 위한 하부 기술이나 공통 기술들이다.

전반적으로는 업무 로직에서는 자동 기능을 사용하고 기술 지원 로직에서는 수동 빈 등록을 사용하는 것이 좋다.  특히 아래와 같은 경우.

- **애플리케이션에 광범위하게 영향을 미치는 기술 지원 객체는 수동 빈으로 등록해서 설정 정보에 바로 나타나게 하는 것이 유지보수 하기 좋다.**

- **비즈니스 로직 중에서 다형성을 적극 활용할 때** : 수동 빈으로 등록하거나 자동으로 하면 특정 패키지에 같이 묶어두어서 딱 보고 이해되도록 해야한다!

스프링과 스프링 부트가 자동으로 등록하는 수많은 빈들은 예외로 그 의도대로 잘 활용하는게 중요하다.  

